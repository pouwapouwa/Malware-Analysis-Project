\chapter{Ganiw}

\section{Introduction}

TODO: Introduction sur les botnets

Le \textit{sample} porté à l'étude porte le doux nom de \textbf{Ganiw} mais est
aussi connu sous les nom de \textbf{BillGates} ou de combinaison comme
\textbf{LINUX.BACKDOOR.GATES}.\\
TODO:md5/sha1\\
Celui-ci semble avoir été étudié pour la première fois en février 2014
sur un site russe: \textit{\href{https://habrahabr.ru/post/213973/}
{Studying the BillGates Linux Botnet}}\footnotemark,
mais continue tout de même à être étudié et à être actif.
En effet, comme il sera expliqué plus amplement par la suite, celui-ci présente
des propriétés particulières.\\

Ce malware est présent uniquement sur les systèmes Linux.
Ce qui n'est pas anodin et sans lien quand à son utilisation: le
développement toujours plus important des objets connectés dans l'IoT
en fait une cible de choix. Linux ou les systèmes basés sur son noyau
(comme avec le projet Yocto\footnotemark) sont donc
des RTOS parfaits (TODO à reformuler) pour de petits appareils
car légers et open-sources et y ont le monopole.
De plus, ces objets connectés sont, en règle générale, peu protégés
(absence de firewall, mots de passe faibles,\ldots)
et non surveillés ou peu maintenus.
Ce sont donc des cibles de choix pour un malware de type \textit{BotNet},
comme \textbf{Ganiw}, pour mener des attaques réseaux de types DDOS par exemple.\\

La suite de cette étude va se faire sous 2 formes: une partie par
analyse statique du binaire et une autre par analyse dynamique,
 permettant de confirmer et approfondir les données recueillies précédemment.

\footnotetext{Traduit depuis le russe}
\footnotetext{\url{https://www.yoctoproject.org/}}

\section{Étude -- Analyse statique}

\subsection{Outils d'analyse}

TODO: description outils et buts d'analyse statique

Description des différents modules avec captures d'écrans ou diagrammes\\
Fonctionnalités autres (hook dans init.d)\\

\subsection{Étude -- Main}

\begin{figure}[!h]

  \centering
  \input{Fig1}
  \caption{Modules mis à disposition du malware}

\end{figure}

Développé en C++, not stripped, "technique anti-debug" (parent !=gdb ← wow)
, fonctionnement modulaire\\

3 modes de fonctionnement --> Screenshot r2\\

Fonctionnement dépend depuis où est lancé le malware.\\

\begin{figure}[!h]

  \centering
  \input{Fig2}
  \caption{Fonctionnement schématique de Ganiw}

\end{figure}

\subsection{Étude -- Beikong/Bill}

Le module Beikong (ou Bill) est le module d'installation mais également le premier module principal du botnet. Son rôle est, d'abord, de nettoyer le système en arrêtant et supprimant les potentielles instances de lui-même qui tournerait déjà sur le système, puis de mettre en place le démarrage automatique de son exécutable au lancement du système et, enfin, de réinstaller et démarrer les modules Backdoor et Monitor. Il s'occupe ensuite de la communcation avec le serveur C&C.\newline

Pseudo-code :
\begin{itemize}
\item Arrête le module Monitor
\item Arrête le module Bill
\item Si la configuration le précise (booléen IsService à Vrai), créer un scrips i\textbf{/etc/init.d/DbSecuritySpt} et des liens symboliques \textbf{/etc/rc$i$.d/S97DbSecuritySpt} (avec $i$ allant de 1 à 5) vers ce script, permettant de lancer l'exécutable actuel au démarrage
\item Si la configuration le précise (booléen DoBackdoor à Vrai), arrête le module Backdoor et le réinstalle (dans \textbf{/usr/bin/bsd-port/getty}) et le relance
\item Si l'exécutable est exécuté en tant que root, indique la localisation du fichier du module Beikong dans \textbf{/tmp/notify.file} et installe/lance le module Monitor (dans \textbf{/usr/bin/.sshd})
\item Exécute MainProcess()
\end{itemize}

%Depuis le main, HGrd9 écrit DbSecuritySpt (g\_strSN), selinux (g\_strBSDN), getty (g\_strBDG), /tmp/moni.lod (g__strML), (g__strGL) avec 'nkfsd8' qui écrit tmp, 'Kusdf9' qui écrit moni, tRd76 qui écrit lod. KDS87y inutil !! 0sdku6 '/tmp/moni.lod'
%\\

\subsection{Étude -- Backdoor}
Le module Backdoor est le deuxième module principal du botnet. Il s'occupe de remplacer quelques outils systèmes classiques par son exécutable pour cacher ses traces. Il s'occupe ensuite d'exécuter les ordres venant du serveur C&C, reçus par le biais du module Bill.\newline

Pseudo-code :
\begin{itemize}
\item Inscrit le pid du processus actuel dans le fichier \textbf{/usr/bin/bsd-port/getty.lock} et lock le fichier
\item Créer un script \textbf{/etc/init.d/selinux} et des liens symboliques \textbf{/etc/rc$i$.d/S99selinux} (avec $i$ allant de 1 à 5) vers ce script, permettant de lancer l'exécutable actuel (\textbf{/usr/bin/bsd-port/getty}) au démarrage
\item Copie et remplace les outils systèmes $netstat$, $lsof$, $ps$ et $ss$ dans les dossiers \textbf{/bin/}, \textbf{/usr/bin/} et \textbf{/usr/sbin/}
\item Exécute MainProcess()
\end{itemize}

\subsection{Étude -- Autres modules}
\subsubsection{Monitor}
Le module Monitor s'occupe de vérifier que le module Bill reste en vie, et de le relancer si il ne l'est plus.

Pseudo-code :
\begin{itemize}
\item Écrit le pid du processus actuel dans le fichier \textbf{/tmp/moni.lod} et lock le fichier
\item Récupère la localisation du fichier Beikong dans \textbf{/tmp/notify.file} et supprime le fichier
\item Démarre un thread "CThreadMonGates" qui vérifie, toutes les 60 secondes, que le fichier \textbf{/tmp/gates.lock} à un lock actif (et donc que le module Bill est toujours vivant) et relance le module Bill si ce n'est pas le cas
\item Boucle à l'infini
\end{itemize}

\subsubsection{Systool}
Le module Systool est le module qui s'exécute lorsque l'exécutable est mis à la place d'un des outils systèmes $netstat$, $lsof$, $ps$ ou $ss$. Son rôle est de filtrer les sorties des outils qu'il remplace pour cacher les parties qui révèlent la présence du module Backdoor.\newline

Pseudo-code :
\begin{itemize}
\item Déduit le chemin de l'outil système original associé, en le dérivant du nom de l'exécutable actuel
\item Si l'outil a été trouvé, on récupère le chemin complet de l'exécutable du module Backdoor ainsi que la valeur du HiddenPort, on exécute l'outil système avec les arguments passés en paramètres et on filtre la sortie en n'affichant pas les références aux chemin et port récupérer précédemment
\end{itemize}

\subsubsection{Update}
TODO

\section{Étude -- Analyse dynamique}

inetsim gdb strace wireshark/tcpdump ++ mise en place vm/dns server/...

Mise en place d'un environnement de travail $+$ outils utilisés (lemon ?)\\
→ crontab trouvé dans l'analyse statique --> fonctionnement fichier rc.

\section{Conclusion}
