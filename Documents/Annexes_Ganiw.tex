\chapter{Annexes}

\begin{algorithm}[H]
  \label{main_algo}
  \caption{Main Pseudocode}
  \begin{algorithmic}[1]
    \State Fermer les descripteurs de fichiers
    \State Première initialisation de variables \Comment Initialise \textit{g\_strMonitorFile}, \textit{g\_iFileSize}, \textit{g\_iHardStart}, \ldots
    \State Chemin absolu du module
    \If {(GetTgtFileSize != g\_iFileSize)} \Comment Test d'intégrité: vérifie que le binaire n'a pas changé de taille
    \State {\textit{SegmentationFault}} \EndIf
    \State Chemin absolu du père
    \If {("gdb" $in$ chemin du père)} \Comment Anti-Debug: vérifie que le processus père n'est pas gdb 
    \State {\textit{Segmentation Fault}} \EndIf
    \State Seconde initialisation de variables \Comment Initialise \textit{g\_strSN}, \textit{g\_strBDSN}, \textit{g\_strBDG}, \ldots
    \State Définition du comportement du binaire \Comment Initialise \textit{g\_iGatesType} en fonction du module activé
    \State Troisième initialisation de variables \Comment Initialise \textit{g\_strConnTgts}, \textit{g\_iGatsPort}, \textit{g\_iDoBackdoor}, \ldots
    \State
    \If {(IsUpdateTemporary)}  \Comment Choix du module
    \State DoUpdate
    \ElsIf {(g\_iGatesTypes = 1)} \State MainBeikong
    \ElsIf {(g\_iGatesType $>$ 1)}
    \If {(g\_iGatesType = 2)} \State MainBackdoor
    \ElsIf {(g\_iGatesType = 3)} \State MainSystool \EndIf
    \ElsIf {(! g\_iGatesType)} \State MainMonitor\EndIf

  \end{algorithmic}
\end{algorithm}

\newpage

\begin{algorithm}[H]
  \label{C++}
  \caption{Décoder et initialiser les premiers flags}
  \begin{lstlisting}
#include <string>
#include <cstring>

using namespace std;

int
ascii_to_dec (char * c)
{
    char v2 = 0;
    if (*c <= 47 || *c > 57)
    {
	if ( *c > 64 && *c <= 70)
	    v2 = *c - 55;
    }
    else
    {
	v2 = *c - 48;
    }
    return v2;
}

int
treatment (char * c1, int c2, char * c3, int c4)
{
    char tmp1;
    char tmp2;
    int result = 0;

    for (signed int i = 0; c2 / 2 > i; i++)
    {
	tmp1 = 16 * ascii_to_dec (c1 + 2 * i);
	tmp2 = tmp1 + ascii_to_dec (c1 + 2 * i + 1);

	if (i < c4)
	{
	    *(c3 + i) = tmp2;
	    ++result;
	}
    }
    return result;
}
int
main ()
{
  string hash_s = "681A1C1543072E0140491F162F0B55545C55775F55565E57745E5D545652705D5E5\
5585F70585C5659577D5C5F565C0423575B025A51720A56";
    const char * hash_c = hash_s.c_str ();
    string param_s = "Google";
    const char * param_c = param_s.c_str ();
    char * tokens;
    char val[512], v4[512];
    double d = 0;
    std::memcpy (val, &d, 512);
    std::memcpy (v4, &d, 512);
    int res = treatment ((char *) hash_c, strlen (hash_c), val, 511);

    for (int i = 0; i < res; i++)
    {
	v4[i] = val[i] ^ param_c[i % (signed int) strlen (param_c)];
    }
    printf ("Result: %s\n\nFlag values:\n", v4);

    tokens = strtok (v4, ":");
    while (tokens)
    {
	printf ("%s\n", tokens);
	tokens = strtok (NULL, ":");
    }
    return EXIT_SUCCESS;
}
  \end{lstlisting}
\end{algorithm}
